#!/bin/bash
set -e

echo "üîÑ –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–µ–ø–ª–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –±–æ—Ç–∞..."

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞ (–∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞)
cd "$(dirname "$0")"

#############################
# –ß–∞—Å—Ç—å 0. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Python 3.10 (3.10.12)
#############################
if ! command -v python3.10 > /dev/null 2>&1; then
    echo "Python 3.10 –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π deadsnakes –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python 3.10 –∏ python3.10-venv..."
    sudo add-apt-repository ppa:deadsnakes/ppa -y
    sudo apt update
    sudo apt install -y python3.10 python3.10-venv
else
    PY_VER=$(python3.10 --version 2>&1)
    echo "–ù–∞–π–¥–µ–Ω $PY_VER"
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤–µ—Ä—Å–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–º–µ–Ω–Ω–æ 3.10.12
fi

#############################
# –ß–∞—Å—Ç—å 1. –î–µ–ø–ª–æ–π –±–æ—Ç–∞
#############################

echo "üîÑ –î–µ–ø–ª–æ–π –±–æ—Ç–∞..."

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–æ—Ç–∞ (–µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω)
if [ -f bot.pid ]; then
    OLD_PID=$(cat bot.pid)
    if ps -p $OLD_PID > /dev/null; then
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å PID $OLD_PID..."
        kill $OLD_PID && echo "‚úÖ –°—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    fi
    rm -f bot.pid
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º python3.10
if [ -d ".venv" ]; then
    if [ -f ".venv/bin/activate" ]; then
        echo "üì¶ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
        source .venv/bin/activate
        VENV_PYTHON="python"
    else
        echo "‚ö†Ô∏è –§–∞–π–ª –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (.venv/bin/activate) –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º .venv/bin/python3.10 –Ω–∞–ø—Ä—è–º—É—é."
        VENV_PYTHON=".venv/bin/python3.10"
    fi
else
    echo "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (.venv) –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –°–æ–∑–¥–∞–µ–º –µ–≥–æ —Å –ø–æ–º–æ—â—å—é Python 3.10..."
    python3.10 -m venv .venv
    if [ -f ".venv/bin/activate" ]; then
        echo "üì¶ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
        source .venv/bin/activate
        VENV_PYTHON="python"
    else
        echo "‚ö†Ô∏è –§–∞–π–ª –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º .venv/bin/python3.10 –Ω–∞–ø—Ä—è–º—É—é."
        VENV_PYTHON=".venv/bin/python3.10"
    fi
fi

echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞..."
$VENV_PYTHON -m pip install --upgrade pip
$VENV_PYTHON -m pip install -r requirements.txt

echo "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
nohup $VENV_PYTHON bot/main.py > bot.log 2>&1 &
echo $! > bot.pid

echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! PID —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ bot.pid"