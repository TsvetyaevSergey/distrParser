#!/bin/bash

echo "üîÑ –î–µ–ø–ª–æ–π –±–æ—Ç–∞..."

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞ (–∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞)
cd "$(dirname "$0")"

# –û—Å—Ç–∞–Ω–æ–≤–∏–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å (–µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞–ø—É—â–µ–Ω —Ä–∞–Ω–µ–µ)
if [ -f bot.pid ]; then
    OLD_PID=$(cat bot.pid)
    if ps -p $OLD_PID > /dev/null; then
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å PID $OLD_PID..."
        kill $OLD_PID && echo "‚úÖ –°—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    fi
    rm bot.pid
fi

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üì¶ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
source .venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ PID
echo "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
nohup python3 bot/main.py > bot.log 2>&1 &
echo $! > bot.pid

echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! PID —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ bot.pid"
